
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-analytics.js";
import { doc, setDoc, getFirestore } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBz1kOpHGbECrAVDQAQN217ycfbM0VjC20",
    authDomain: "english-quizzz.firebaseapp.com",
    projectId: "english-quizzz",
    storageBucket: "english-quizzz.appspot.com",
    messagingSenderId: "531636974687",
    appId: "1:531636974687:web:987866ab854ddf5f9597ea",
    measurementId: "G-0GCR06880E"
};


const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

const db = getFirestore();

async function SignUpNewUser(firstName, lastName, email, password) {
    var ref = doc(db, "UsersList", email);

    const docRef = await setDoc(
        ref, {
            UserFirstName: firstName,
            UserLastName: lastName,
            UserEmail: email,
            UserPassword: password,
            UserFullName: firstName+" "+lastName
        }
    )
    .then(() => {
        alert("Congratulations! Your English Quizzz account is created. You can go to login page to login. We hope you have a good experience.");
        window.open("/login", "_parent");
    })
    .catch((error) => {
        alert("Error: "+error);
    });
}

function change() {
    if(document.querySelector("#passwordbox").getAttribute("type") == "text") {
        document.querySelector("#passwordbox").setAttribute("type", "password");
        document.querySelector("#conpasswordbox").setAttribute("type", "password");
    }
    else if(document.querySelector("#passwordbox").getAttribute("type") == "password") {
        document.querySelector("#passwordbox").setAttribute("type", "text");
        document.querySelector("#conpasswordbox").setAttribute("type", "text");
    }
}

document.getElementById("showpassword").addEventListener("click", change);

var emailbox = document.querySelector("#emailbox");
var fnamebox = document.querySelector("#fnamebox");
var lnamebox = document.querySelector("#lnamebox");
var passwordbox = document.querySelector("#passwordbox");
var conpasswordbox = document.querySelector("#conpasswordbox");
var allConsOk;

document.querySelector(".signupbtn").addEventListener("click", function () {
    if(emailbox.value != null && fnamebox.value != null && lnamebox.value != null && passwordbox.value != null && passwordbox.value == conpasswordbox.value && !passwordbox.value.includes("#")) {
        allConsOk = true;
    }
    else {
        allConsOk = false;
    }

    if(passwordbox.value.includes("#")) {
        alert("Password cannot contain #");
    }

    if(allConsOk) {
        fetch("/hash/"+passwordbox.value)
        .then(res => res.json())
        .then((res) => {
            var newP = res.hashedPassword;
            SignUpNewUser(fnamebox.value, lnamebox.value, emailbox.value, newP);
        })
        .catch(err => {
            console.log(err);
        });
    }
    else {
        alert("Sorry but please make sure all the fields are filled. Also, please check if Password and confirm password match.");
    }
});